<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="title">CryptoPulse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.rel='stylesheet'">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #0e0e10;
      --text-color: #f0f0f0;
      --card-bg: #1f1f23;
      --card-hover: #27272a;
      --primary-color: #3b82f6;
      --accent-color: #93c5fd;
      --positive-color: #22c55e;
      --negative-color: #ef4444;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      --gradient: linear-gradient(135deg, #6b46c1, #2b6cb0, #0987a0);
    }
    [data-theme="light"] {
      --bg-color: #f3f4f6;
      --text-color: #1f2937;
      --card-bg: #ffffff;
      --card-hover: #f9fafb;
      --primary-color: #2563eb;
      --accent-color: #60a5fa;
      --positive-color: #16a34a;
      --negative-color: #dc2626;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #93c5fd, #60a5fa, #3b82f6);
    }
    [data-theme="green"] {
      --primary-color: #16a34a;
      --accent-color: #4ade80;
      --gradient: linear-gradient(135deg, #16a34a, #4ade80, #22d3ee);
    }
    [data-theme="purple"] {
      --primary-color: #6b46c1;
      --accent-color: #a78bfa;
      --gradient: linear-gradient(135deg, #6b46c1, #a78bfa, #7c3aed);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom, var(--bg-color), rgba(24, 24, 27, 0.8));
      color: var(--text-color);
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    header {
      background: var(--gradient);
      padding: 8px 16px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(90deg, #ffffff, #93c5fd, #ffffff);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 1px;
      animation: gradientShift 4s ease-in-out infinite;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .menu-icon {
      font-size: 1.3rem;
      cursor: pointer;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.3);
      padding: 8px;
      border-radius: 8px;
      transition: background 0.3s ease, transform 0.2s ease;
      z-index: 1001;
    }
    .menu-icon:hover { background: rgba(0, 0, 0, 0.5); transform: scale(1.1); }
    .menu-icon svg { width: 24px; height: 24px; }

    .dropdown {
      display: none;
      position: absolute;
      top: 56px;
      right: 16px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      z-index: 1000;
      min-width: 240px;
      padding: 12px 0;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      role="menu";
      aria-expanded="false";
    }
    .dropdown.active {
      display: block;
      opacity: 1;
      transform: translateY(0);
      aria-expanded="true";
    }
    .dropdown .category {
      padding: 8px 16px;
      font-size: 0.85rem;
      color: #9ca3af;
      font-weight: 600;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dropdown .category svg { width: 16px; height: 16px; fill: #9ca3af; }
    .dropdown a {
      display: block;
      padding: 8px 16px;
      color: var(--text-color);
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .dropdown a:hover { background: var(--card-hover); color: var(--accent-color); }

    .language-selector, .theme-toggle {
      display: flex;
      align-items: center;
      color: #ffffff;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }
    .language-selector select {
      background: transparent;
      border: none;
      color: #ffffff;
      font-size: 0.85rem;
      padding: 4px;
      cursor: pointer;
      appearance: none;
    }
    .language-selector svg, .theme-toggle svg { width: 18px; height: 18px; margin-right: 6px; }

    .font-controls button {
      padding: 6px 12px;
      background: var(--card-bg);
      border: none;
      border-radius: 6px;
      color: var(--text-color);
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      margin-right: 8px;
    }
    .font-controls button:hover { background: var(--primary-color); transform: scale(1.05); }

    .market-section {
      max-width: 1280px;
      margin: 24px auto;
      padding: 0 12px;
      text-align: center;
    }
    .market-section h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 20px;
      letter-spacing: 0.5px;
    }

    .stats-controls, .filter-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .stats-controls label, .filter-controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    .stats-controls input[type="checkbox"] { accent-color: var(--primary-color); cursor: pointer; }
    .filter-controls select {
      padding: 8px;
      background: var(--card-bg);
      border: none;
      border-radius: 6px;
      color: var(--text-color);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .market-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      aria-live="polite";
    }
    .market-stats.loading .loader {
      display: block;
    }
    .loader {
      display: none;
      text-align: center;
      padding: 20px;
    }
    .market-stats.loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
    }
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
    .stat-card {
      padding: 12px;
      background: var(--card-hover);
      border-radius: 8px;
      text-align: left;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.7s ease-out forwards;
    }
    .stat-card:hover { box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); transform: translateY(-2px); }
    .stat-card:nth-child(2) { animation-delay: 0.1s; }
    .stat-card:nth-child(3) { animation-delay: 0.2s; }
    .stat-card h3 { font-size: 0.85rem; color: #9ca3af; margin-bottom: 8px; }
    .stat-card p { font-size: 1rem; font-weight: 600; color: var(--text-color); }

    .search-bar {
      margin: 20px auto;
      display: flex;
      align-items: center;
      max-width: 720px;
      position: relative;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: transform 0.3s ease;
    }
    .search-bar:hover { transform: scale(1.02); }
    .search-bar input {
      padding: 10px 10px 10px 36px;
      font-size: 0.95rem;
      width: 100%;
      border: none;
      background: transparent;
      color: var(--text-color);
      transition: background 0.3s ease;
    }
    .search-bar input:focus { outline: none; background: var(--card-hover); }
    .search-bar svg {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      fill: #9ca3af;
    }
    .search-bar button {
      padding: 10px 18px;
      background: var(--primary-color);
      border: none;
      border-radius: 0 10px 10px 0;
      color: #ffffff;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    }
    .search-bar button:hover { background: #2563eb; }
    .search-bar button:active {
      transform: scale(0.95);
      box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 16px auto;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pagination button {
      padding: 6px 14px;
      font-size: 0.85rem;
      background: var(--card-bg);
      color: var(--text-color);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .pagination button:hover { background: var(--primary-color); transform: scale(1.05); }
    .pagination button:disabled {
      background: var(--card-bg);
      color: #6b7280;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .pagination .page-info { font-size: 0.85rem; color: #9ca3af; }
    .pagination.hidden { display: none; }

    table {
      width: 100%;
      max-width: 1280px;
      margin: 16px auto;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
      position: relative;
      aria-live="polite";
    }
    table.loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
    }
    th, td {
      padding: 10px 14px;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      color: var(--accent-color);
      font-weight: 600;
      background: var(--card-hover);
      cursor: pointer;
      position: relative;
      transition: background 0.3s ease;
    }
    th:hover { background: #333; }
    th.sorted::after {
      content: '↑';
      position: absolute;
      right: 8px;
      font-size: 0.8rem;
      color: var(--accent-color);
    }
    th.sorted.desc::after { content: '↓'; }
    tbody tr {
      border-bottom: 1px solid #2d2d31;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    tbody tr:hover {
      background: var(--card-hover);
      cursor: pointer;
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }
    .positive { color: var(--positive-color); font-weight: 500; }
    .negative { color: var(--negative-color); font-weight: 500; }
    .coin-icon {
      width: 22px;
      height: 22px;
      vertical-align: middle;
      margin-right: 8px;
      border-radius: 50%;
    }
    .no-results, .error-message {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 0.9rem;
    }
    .price sup {
      font-size: 0.6rem;
      vertical-align: super;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      max-width: 640px;
      width: 95%;
      position: relative;
      box-shadow: var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      font-size: 1.4rem;
      margin-bottom: 14px;
      font-weight: 600;
      color: var(--text-color);
    }
    .modal-content p {
      font-size: 0.95rem;
      color: #d1d5db;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .modal-content a {
      color: var(--accent-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    .modal-content a:hover { color: #60a5fa; text-decoration: underline; }
    .modal-chart {
      margin-top: 20px;
      max-height: 300px;
      width: 100%;
      background: #18181b;
      padding: 14px;
      border-radius: 8px;
    }
    .modal-chart-error {
      color: #9ca3af;
      text-align: center;
      margin-top: 10px;
      font-size: 0.85rem;
    }
    .close {
      position: absolute;
      top: 14px;
      right: 14px;
      font-size: 1.4rem;
      cursor: pointer;
      color: #9ca3af;
      transition: color 0.3s ease;
    }
    .close:hover { color: var(--text-color); }

    footer {
      text-align: center;
      padding: 16px;
      font-size: 0.8rem;
      color: #9ca3af;
      border-top: 1px solid #2d2d31;
      margin-top: 24px;
      background: var(--card-bg);
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    @media (max-width: 768px) {
      header { padding: 6px 12px; }
      header h1 { font-size: 1.3rem; }
      .controls { gap: 6px; }
      .menu-icon { font-size: 1.2rem; padding: 6px; }
      .dropdown { top: 50px; right: 10px; min-width: 200px; }
      .dropdown a { font-size: 0.8rem; padding: 6px 12px; }
      .market-section { padding: 0 10px; }
      .market-section h2 { font-size: 1.1rem; }
      .market-stats { grid-template-columns: 1fr; padding: 12px; }
      .stats-controls, .filter-controls { gap: 8px; }
      .stats-controls label, .filter-controls label { font-size: 0.85rem; }
      .search-bar { margin: 16px auto; max-width: 95%; }
      .search-bar input { font-size: 0.9rem; padding: 8px 8px 8px 32px; }
      .search-bar button { padding: 8px 14px; font-size: 0.8rem; }
      .pagination button { padding: 5px 12px; font-size: 0.8rem; }
      .pagination .page-info { font-size: 0.8rem; }
      table { font-size: 0.85rem; }
      th, td { padding: 8px 10px; font-size: 0.8rem; }
      .coin-icon { width: 20px; height: 20px; }
      .modal-content { padding: 14px; max-width: 98%; }
      .modal-content h2 { font-size: 1.2rem; }
      .modal-content p { font-size: 0.9rem; }
      .modal-chart { max-height: 220px; padding: 10px; }
    }

    @media (max-width: 480px) {
      header { padding: 4px 8px; }
      header h1 { font-size: 1.1rem; }
      .menu-icon { padding: 5px; }
      .menu-icon svg { width: 20px; height: 20px; }
      .dropdown { top: 48px; min-width: 180px; }
      .search-bar input { font-size: 0.85rem; }
      .search-bar svg { width: 16px; height: 16px; }
      th, td { font-size: 0.75rem; padding: 6px 8px; }
      .modal-content { padding: 10px; }
      .modal-chart { max-height: 180px; }
      .stat-card h3 { font-size: 0.8rem; }
      .stat-card p { font-size: 0.9rem; }
      .stats-controls label, .filter-controls label { font-size: 0.8rem; }
    }

    @media (min-width: 1200px) {
      header h1 { font-size: 1.8rem; }
      .market-section h2 { font-size: 1.4rem; }
      .search-bar { max-width: 800px; }
      .market-stats { gap: 16px; padding: 20px; }
      .stat-card { padding: 16px; }
      .stat-card h3 { font-size: 0.9rem; }
      .stat-card p { font-size: 1.2rem; }
      th, td { padding: 12px 16px; font-size: 1rem; }
      .modal-content { max-width: 720px; }
      .modal-chart { max-height: 340px; }
    }
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="title">CryptoPulse</h1>
    <div class="controls">
      <span class="theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
        <span data-i18n="theme">Tema Escuro</span>
      </span>
      <span class="language-selector" aria-label="Selecionar idioma">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
        <select onchange="changeLanguage(this.value)">
          <option value="pt">Português</option>
          <option value="en">English</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
        </select>
      </span>
      <div class="font-controls">
        <button onclick="adjustFontSize(1)" aria-label="Aumentar tamanho da fonte" data-i18n="font_increase">A+</button>
        <button onclick="adjustFontSize(-1)" aria-label="Diminuir tamanho da fonte" data-i18n="font_decrease">A-</button>
      </div>
      <span class="menu-icon" onclick="toggleDropdown()" aria-label="Abrir menu">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      </span>
    </div>
    <div class="dropdown" id="crypto-links" role="menu" aria-expanded="false">
      <div class="category" data-i18n="category_tools">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.7 6.3a1 1 0 0 0-1.4 0l-4 4a1 1 0 0 0 0 1.4l4 4a1 1 0 0 0 1.4 0l4-4a1 1 0 0 0 0-1.4l-4-4zM12 20a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/></svg>
        Ferramentas
      </div>
      <a href="portfolio.html" data-i18n="portfolio">Portfolio Pessoal</a>
      <a href="tools.html" data-i18n="trackers">Rastreador & Exploradores</a>
      <a href="precision-settings.html" data-i18n="precision_settings">Configurações de Precisão</a>
      <div class="category" data-i18n="category_data">Dados</div>
      <a href="https://coinmarketcap.com" target="_blank">CoinMarketCap</a>
      <a href="https://www.coingecko.com" target="_blank">CoinGecko</a>
      <a href="https://www.tradingview.com" target="_blank" data-i18n="tradingview">TradingView (Gráficos)</a>
      <div class="category" data-i18n="category_analysis">Análises</div>
      <a href="https://messari.io" target="_blank">Messari</a>
      <a href="https://defillama.com" target="_blank" data-i18n="defillama">DefiLlama (DeFi)</a>
      <a href="https://cryptoquant.com" target="_blank" data-i18n="cryptoquant">CryptoQuant (On-Chain)</a>
      <a href="https://token.unlocks.app" target="_blank" data-i18n="token_unlocks">Token Unlocks</a>
      <a href="https://dune.com" target="_blank" data-i18n="dune">Dune Analytics (On-Chain)</a>
      <a href="https://lunarcrush.com" target="_blank" data-i18n="lunarcrush">LunarCrush (Sentimento)</a>
      <a href="https://whale-alert.io" target="_blank" data-i18n="whale_alert">Whale Alert (Baleias)</a>
      <div class="category" data-i18n="category_exchanges">Exchanges</div>
      <a href="https://www.binance.com" target="_blank">Binance</a>
      <a href="https://www.coinbase.com" target="_blank">Coinbase</a>
      <div class="category" data-i18n="category_news">Notícias</div>
      <a href="https://www.coindesk.com" target="_blank">CoinDesk</a>
    </div>
  </header>
  <div class="market-section">
    <h2 data-i18n="market_title">Mercado de Criptomoedas</h2>
    <div class="stats-controls">
      <label><input type="checkbox" id="show-market-cap" checked onchange="updateStatsDisplay()"> <span data-i18n="total_market_cap">Capitalização Total</span></label>
      <label><input type="checkbox" id="show-volume-24h" checked onchange="updateStatsDisplay()"> <span data-i18n="volume_24h">Volume 24h</span></label>
      <label><input type="checkbox" id="show-btc-dominance" checked onchange="updateStatsDisplay()"> <span data-i18n="btc_dominance">Dominância do Bitcoin</span></label>
    </div>
    <div class="market-stats loading" id="market-stats" aria-live="polite">
      <div class="loader" role="status">
        <span class="visually-hidden" data-i18n="loading">Carregando...</span>
      </div>
      <div class="stat-card" id="market-cap-card">
        <h3 data-i18n="total_market_cap">Capitalização Total</h3>
        <p id="total-market-cap">Carregando...</p>
      </div>
      <div class="stat-card" id="volume-24h-card">
        <h3 data-i18n="volume_24h">Volume 24h</h3>
        <p id="volume-24h">Carregando...</p>
      </div>
      <div class="stat-card" id="btc-dominance-card">
        <h3 data-i18n="btc_dominance">Dominância do Bitcoin</h3>
        <p id="btc-dominance">Carregando...</p>
      </div>
    </div>
    <div class="filter-controls">
      <select id="category-filter" onchange="filterTable()">
        <option value="" data-i18n="all_categories">Todas as Categorias</option>
        <option value="defi" data-i18n="defi">DeFi</option>
        <option value="meme" data-i18n="meme">Meme Coins</option>
        <option value="stablecoin" data-i18n="stablecoin">Stablecoins</option>
      </select>
      <button onclick="exportToCSV()" data-i18n="export_csv">Exportar como CSV</button>
    </div>
    <div class="search-bar">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
      <input type="text" id="search-input" data-i18n-placeholder="search_placeholder" placeholder="Pesquisar por nome, símbolo ou endereço de contrato..." onkeyup="filterTable()">
      <button onclick="filterTable()" data-i18n="search_button">Buscar</button>
    </div>
    <div class="pagination hidden" id="pagination">
      <button onclick="changePage(-1)" id="prev-page" disabled data-i18n="previous">Anterior</button>
      <span class="page-info" id="page-info" data-i18n="page">Página 1</span>
      <button onclick="changePage(1)" id="next-page" data-i18n="next">Próximo</button>
    </div>
    <table id="crypto-table" class="loading">
      <thead>
        <tr>
          <th onclick="sortTable('cmc_rank')" data-i18n="rank">#</th>
          <th onclick="sortTable('name')" data-i18n="coin">Moeda</th>
          <th onclick="sortTable('price')" data-i18n="price">Preço (24h)</th>
          <th onclick="sortTable('market_cap')" data-i18n="market_cap">Market Cap</th>
          <th onclick="sortTable('market_cap_dominance')" data-i18n="dominance">Dominância</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="5" data-i18n="loading">Carregando...</td></tr></tbody>
    </table>
  </div>
  <div id="modal" class="modal">
    <div class="modal-content" tabindex="-1">
      <span class="close" onclick="closeModal()" aria-label="Fechar modal">×</span>
      <h2 id="modal-title"></h2>
      <p id="modal-price" data-i18n-prefix="price_label">Preço: </p>
      <p id="modal-market-cap" data-i18n-prefix="market_cap_label">Market Cap: </p>
      <p id="modal-dominance" data-i18n-prefix="dominance_label">Dominância: </p>
      <p id="modal-contract" data-i18n-prefix="contract_label">Contrato: </p>
      <p id="modal-website" data-i18n-prefix="website_label">Website: </p>
      <canvas id="modal-chart" class="modal-chart"></canvas>
      <p id="modal-chart-error" class="modal-chart-error" style="display: none;" data-i18n="chart_error">Erro ao carregar gráfico</p>
    </div>
  </div>
  <footer>
    <span data-i18n="footer">© 2025 CryptoPulse | Dados: CoinMarketCap, CoinGecko</span>
  </footer>
  <script type="module">
    import { translations, changeLanguage } from './i18n.js';

    const cmcApiKey = "9e0ef985-caf5-43d3-90e0-a73304b5546e";
    const cmcApiUrl = 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?limit=5000&convert=BRL';
    const cmcGlobalUrl = 'https://pro-api.coinmarketcap.com/v1/global-metrics/quotes/latest?convert=BRL';
    const cgApiUrl = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=brl&per_page=250&page=';
    let cryptoData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 50;
    let debounceTimeout;
    let sortColumn = 'cmc_rank';
    let sortDirection = 1;
    let priceChart = null;
    const contractCache = {};
    const popularCoinsCache = new Map();
    const debounceTime = navigator.hardwareConcurrency > 4 ? 200 : 400;

    const store = {
      state: { cryptoData: [], filteredData: [], currentPage: 1 },
      setState(newState) {
        Object.assign(this.state, newState);
        this.notify();
      },
      subscribers: [],
      subscribe(fn) { this.subscribers.push(fn); },
      notify() { this.subscribers.forEach(fn => fn(this.state)); }
    };

    const mockData = [
      { id: "coinmarketcap-1", name: "Bitcoin", symbol: "BTC", slug: "bitcoin", cmc_rank: 1, quote: { BRL: { price: 350000, percent_change_24h: 2.5, market_cap: 7000000000000, market_cap_dominance: 50 } }, contract_address: null, category: '' },
      { id: "coinmarketcap-1027", name: "Ethereum", symbol: "ETH", slug: "ethereum", cmc_rank: 2, quote: { BRL: { price: 15000, percent_change_24h: -1.2, market_cap: 1800000000000, market_cap_dominance: 20 } }, contract_address: null, category: 'defi' },
      { id: "coinmarketcap-9999", name: "Shiba Inu", symbol: "SHIB", slug: "shiba-inu", cmc_rank: 3, quote: { BRL: { price: 0.00012345, percent_change_24h: 1.5, market_cap: 72000000000, market_cap_dominance: 0.5 } }, contract_address: "0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE", category: 'meme' },
      { id: "coinmarketcap-9998", name: "Tether", symbol: "USDT", slug: "tether", cmc_rank: 4, quote: { BRL: { price: 5.5, percent_change_24h: 0.1, market_cap: 150000000000, market_cap_dominance: 1.2 } }, contract_address: null, category: 'stablecoin' }
    ];

    const mockHistoricalData = {
      prices: [
        [Date.now() - 6 * 24 * 60 * 60 * 1000, 340000],
        [Date.now() - 5 * 24 * 60 * 60 * 1000, 345000],
        [Date.now() - 4 * 24 * 60 * 60 * 1000, 350000],
        [Date.now() - 3 * 24 * 60 * 60 * 1000, 348000],
        [Date.now() - 2 * 24 * 60 * 60 * 1000, 352000],
        [Date.now() - 1 * 24 * 60 * 60 * 1000, 355000],
        [Date.now(), 350000]
      ]
    };

    function sanitizeInput(input) {
      return input.replace(/[<>&"']/g, char => ({
        '<': '&lt;',
        '>': '&gt;',
        '&': '&amp;',
        '"': '&quot;',
        "'": '&apos;'
      })[char]);
    }

    function loadPrecisionSettings() {
      return JSON.parse(localStorage.getItem('precisionSettings')) || {
        showDecimals: false,
        decimalPlaces: 2,
        showStablecoins: true,
        showMemeCoins: true
      };
    }

    function formatPrice(price) {
      const settings = loadPrecisionSettings();
      if (!price || isNaN(price)) return 'R$ N/A';
      if (settings.showDecimals) {
        return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: settings.decimalPlaces, maximumFractionDigits: settings.decimalPlaces })}`;
      }
      if (price >= 1) {
        return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: settings.decimalPlaces, maximumFractionDigits: settings.decimalPlaces })}`;
      }
      const priceStr = price.toFixed(6).replace(/\.?0+$/, '');
      const parts = priceStr.split('.');
      const decimal = parts[1] || '';
      let zeroCount = 0;
      for (let i = 0; i < decimal.length; i++) {
        if (decimal[i] === '0') zeroCount++;
        else break;
      }
      if (zeroCount === 0) {
        return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: settings.decimalPlaces, maximumFractionDigits: settings.decimalPlaces })}`;
      }
      const superscriptDigits = ['⁰', '¹', '²', '³', '⁴', '⁵', '⁶', '⁷', '⁸', '⁹'];
      const superscript = superscriptDigits[zeroCount];
      const significantPart = decimal.slice(zeroCount, zeroCount + 2).padEnd(2, '0');
      return `R$ 0,<sup>${superscript}</sup>${significantPart}`;
    }

    async function getCachedData(key, fetchFn, ttl = 600000) {
      const cached = localStorage.getItem(key);
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < ttl) return data;
      }
      const data = await fetchFn();
      localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
      cachePopularCoins(data);
      return data;
    }

    function cachePopularCoins(coins) {
      coins.slice(0, 100).forEach(coin => popularCoinsCache.set(coin.id, coin));
      localStorage.setItem('popularCoins', JSON.stringify([...popularCoinsCache]));
    }

    async function fetchCmcData() {
      try {
        const res = await fetch(cmcApiUrl, { headers: { "X-CMC_PRO_API_KEY": cmcApiKey } });
        if (!res.ok) throw new Error(`Erro na API CoinMarketCap: ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (data.status.error_code !== 0) throw new Error(`Erro da API: ${data.status.error_message}`);
        return data.data.map(coin => ({
          id: `coinmarketcap-${coin.id}`,
          name: coin.name,
          symbol: coin.symbol,
          slug: coin.slug,
          cmc_rank: coin.cmc_rank || Infinity,
          quote: coin.quote || { BRL: { price: 0, percent_change_24h: 0, market_cap: 0, market_cap_dominance: 0 } },
          contract_address: null,
          category: coin.tags?.includes('defi') ? 'defi' : coin.tags?.includes('meme-token') ? 'meme' : coin.tags?.includes('stablecoin') ? 'stablecoin' : ''
        }));
      } catch (err) {
        throw err;
      }
    }

    async function fetchCmcGlobalData() {
      try {
        const res = await fetch(cmcGlobalUrl, { headers: { "X-CMC_PRO_API_KEY": cmcApiKey } });
        if (!res.ok) throw new Error(`Erro na API CoinMarketCap Global: ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (data.status.error_code !== 0) throw new Error(`Erro da API: ${data.status.error_message}`);
        return data.data;
      } catch (err) {
        console.warn('Erro ao buscar dados globais:', err.message);
        return { quote: { BRL: { total_market_cap: 0, total_volume_24h: 0, btc_dominance: 0 } } };
      }
    }

    async function fetchCgData() {
      let allCoins = [];
      let page = 1;
      try {
        while (true) {
          const res = await fetch(`${cgApiUrl}${page}`);
          if (!res.ok) throw new Error(`Erro na API CoinGecko: ${res.status} ${res.statusText}`);
          const data = await res.json();
          if (data.length === 0) break;
          allCoins = allCoins.concat(data.map(coin => ({
            id: `coingecko-${coin.id}`,
            name: coin.name,
            symbol: coin.symbol.toUpperCase(),
            slug: coin.id,
            cmc_rank: coin.market_cap_rank || Infinity,
            quote: {
              BRL: {
                price: coin.current_price || 0,
                percent_change_24h: coin.price_change_percentage_24h || 0,
                market_cap: coin.market_cap || 0,
                market_cap_dominance: coin.market_cap && coin.total_market_cap ? (coin.market_cap / coin.total_market_cap) * 100 : 0
              }
            },
            contract_address: null,
            category: coin.categories?.includes('DeFi') ? 'defi' : coin.categories?.includes('Meme Token') ? 'meme' : coin.categories?.includes('Stablecoin') ? 'stablecoin' : ''
          })));
          page++;
        }
        return allCoins;
      } catch (err) {
        throw err;
      }
    }

    async function fetchContractAddresses(coins) {
      const uncachedCoins = coins.filter(coin => !contractCache[coin.id]);
      if (uncachedCoins.length === 0) return;
      try {
        const cmcIds = uncachedCoins.filter(coin => coin.id.startsWith('coinmarketcap')).map(coin => coin.id.split('-')[1]).join(',');
        if (cmcIds) {
          const res = await fetch(`https://pro-api.coinmarketcap.com/v1/cryptocurrency/info?id=${cmcIds}`, { headers: { "X-CMC_PRO_API_KEY": cmcApiKey } });
          if (res.ok) {
            const data = await res.json();
            Object.entries(data.data).forEach(([id, info]) => {
              contractCache[`coinmarketcap-${id}`] = info.platform ? info.platform.token_address : null;
            });
          }
        }
      } catch (err) {
        console.warn('Erro ao buscar contratos no CoinMarketCap:', err.message);
      }
      for (const coin of uncachedCoins.filter(c => c.id.startsWith('coingecko'))) {
        if (contractCache[coin.id]) continue;
        try {
          const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coin.slug}`);
          if (res.ok) {
            const data = await res.json();
            contractCache[coin.id] = data.contract_address || null;
          }
        } catch (err) {
          console.warn(`Erro ao buscar contrato para ${coin.name}:`, err.message);
          contractCache[coin.id] = null;
        }
      }
      coins.forEach(coin => { coin.contract_address = contractCache[coin.id] || null; });
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme') || 'dark';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      const lang = localStorage.getItem('language') || 'pt';
      const themeText = newTheme === 'dark' ? translations[lang].theme : translations[lang].theme.replace('Escuro', 'Claro').replace('Dark', 'Light').replace('Oscuro', 'Claro').replace('Sombre', 'Clair').replace('Dunkles', 'Helles');
      document.querySelector('.theme-toggle span').textContent = themeText;
    }

    function changeTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    }

    function adjustFontSize(delta) {
      const root = document.documentElement;
      const currentSize = parseFloat(getComputedStyle(root).fontSize);
      const newSize = Math.max(12, Math.min(18, currentSize + delta));
      root.style.fontSize = `${newSize}px`;
      localStorage.setItem('fontSize', newSize);
    }

    function toggleDropdown() {
      const dropdown = document.getElementById('crypto-links');
      const isActive = dropdown.classList.toggle('active');
      dropdown.setAttribute('aria-expanded', isActive);
    }

    function loadStatsPreferences() {
      const preferences = JSON.parse(localStorage.getItem('statsPreferences')) || {
        marketCap: true,
        volume24h: true,
        btcDominance: true
      };
      document.getElementById('show-market-cap').checked = preferences.marketCap;
      document.getElementById('show-volume-24h').checked = preferences.volume24h;
      document.getElementById('show-btc-dominance').checked = preferences.btcDominance;
      updateStatsDisplay();
    }

    function saveStatsPreferences() {
      const preferences = {
        marketCap: document.getElementById('show-market-cap').checked,
        volume24h: document.getElementById('show-volume-24h').checked,
        btcDominance: document.getElementById('show-btc-dominance').checked
      };
      localStorage.setItem('statsPreferences', JSON.stringify(preferences));
    }

    function updateStatsDisplay() {
      const marketCapCard = document.getElementById('market-cap-card');
      const volume24hCard = document.getElementById('volume-24h-card');
      const btcDominanceCard = document.getElementById('btc-dominance-card');
      marketCapCard.style.display = document.getElementById('show-market-cap').checked ? 'block' : 'none';
      volume24hCard.style.display = document.getElementById('show-volume-24h').checked ? 'block' : 'none';
      btcDominanceCard.style.display = document.getElementById('show-btc-dominance').checked ? 'block' : 'none';
      saveStatsPreferences();
    }

    async function updateMarketStats() {
      document.getElementById('market-stats').classList.add('loading');
      const globalData = await fetchCmcGlobalData();
      document.getElementById('market-stats').classList.remove('loading');
      const totalMarketCap = globalData.quote.BRL.total_market_cap ?
        `R$ ${globalData.quote.BRL.total_market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : 'N/A';
      const volume24h = globalData.quote.BRL.total_volume_24h ?
        `R$ ${globalData.quote.BRL.total_volume_24h.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : 'N/A';
      const btcDominance = globalData.quote.BRL.btc_dominance ?
        `${globalData.quote.BRL.btc_dominance.toFixed(2)}%` : 'N/A';
      document.getElementById('total-market-cap').textContent = totalMarketCap;
      document.getElementById('volume-24h').textContent = volume24h;
      document.getElementById('btc-dominance').textContent = btcDominance;
    }

    async function fetchCryptoData() {
      document.getElementById('crypto-table').classList.add('loading');
      try {
        cryptoData = await getCachedData('cryptoData', fetchCmcData);
        await fetchContractAddresses(cryptoData.slice(0, 100));
        await updateMarketStats();
        store.setState({ cryptoData, filteredData: cryptoData });
        filterTable();
      } catch (err) {
        console.error('Erro ao carregar dados do CoinMarketCap:', err.message);
        try {
          cryptoData = await getCachedData('cryptoDataCg', fetchCgData);
          await fetchContractAddresses(cryptoData.slice(0, 100));
          await updateMarketStats();
          store.setState({ cryptoData, filteredData: cryptoData });
          filterTable();
        } catch (cgErr) {
          console.error('Erro ao carregar dados do CoinGecko:', cgErr.message);
          document.querySelector("#crypto-table tbody").innerHTML =
            `<tr><td colspan="5" class="error-message" data-i18n="error_loading">Erro ao carregar dados: ${cgErr.message}. Usando dados de teste.</td></tr>`;
          cryptoData = mockData;
          filteredData = mockData;
          store.setState({ cryptoData, filteredData });
          renderTable(getPageData());
          changeLanguage(localStorage.getItem('language') || 'pt');
          await updateMarketStats();
        }
      } finally {
        document.getElementById('crypto-table').classList.remove('loading');
      }
    }

    function getPageData() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      return filteredData.slice(start, end);
    }

    function updatePagination() {
      const pagination = document.getElementById('pagination');
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (filteredData.length <= 10 && document.getElementById('search-input').value === '') {
        pagination.classList.add('hidden');
      } else {
        pagination.classList.remove('hidden');
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
        document.getElementById('page-info').textContent = translations[localStorage.getItem('language') || 'pt'].page.replace('{0}', `${currentPage} de ${totalPages || 1}`);
      }
    }

    function changePage(delta) {
      currentPage += delta;
      if (currentPage < 1) currentPage = 1;
      store.setState({ currentPage });
      renderTable(getPageData());
      updatePagination();
    }

    function renderTable(data) {
      const tableBody = document.querySelector("#crypto-table tbody");
      tableBody.innerHTML = "";
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="5" class="no-results" data-i18n="no_results">Nenhuma moeda encontrada.</td></tr>`;
        changeLanguage(localStorage.getItem('language') || 'pt');
        return;
      }
      requestAnimationFrame(() => {
        data.forEach((coin) => {
          const changeClass = (coin.quote.BRL.percent_change_24h || 0) >= 0 ? "positive" : "negative";
          const price = formatPrice(coin.quote.BRL.price);
          const marketCap = coin.quote.BRL.market_cap ?
            `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : 'N/A';
          const dominance = coin.quote.BRL.market_cap_dominance ?
            `${coin.quote.BRL.market_cap_dominance.toFixed(2)}%` : 'N/A';
          const iconUrl = coin.id.startsWith('coinmarketcap') ?
            `https://s2.coinmarketcap.com/static/img/coins/64x64/${coin.id.split('-')[1]}.png` :
            `https://assets.coingecko.com/coins/images/${coin.id.split('-')[1]}/thumb/${coin.slug}.png?154703${coin.id.split('-')[1]}.png`;
          tableBody.innerHTML += `
            <tr onclick="showModal('${coin.id}', '${coin.slug}')">
              <td>#${coin.cmc_rank || 'N/A'}</td>
              <td><img src="${iconUrl}" class="coin-icon" alt="${coin.name} icon" loading="lazy" onerror="this.src='https://s2.coinmarketcap.com/static/img/coins/64x64/1.png'">${coin.name} (${coin.symbol})</td>
              <td class="price">${price || 'R$ N/A'}<br><span class="${changeClass}">${(coin.quote.BRL.percent_change_24h || 0).toFixed(2)}%</span></td>
              <td>${marketCap}</td>
              <td>${dominance}</td>
            </tr>
          `;
        });
      });
    }

    function filterTable() {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(async () => {
        document.getElementById('crypto-table').classList.add('loading');
        const settings = loadPrecisionSettings();
        const searchValue = sanitizeInput(document.getElementById("search-input").value).toLowerCase().trim();
        const category = document.getElementById("category-filter").value;
        currentPage = 1;
        if (searchValue === "" && !category) {
          filteredData = cryptoData.filter(coin => coin.cmc_rank <= 10).sort((a, b) => a.cmc_rank - b.cmc_rank);
        } else {
          filteredData = cryptoData.filter(coin => {
            const isAddress = searchValue.startsWith('0x');
            const matchesSearch = isAddress && coin.contract_address ?
              coin.contract_address.toLowerCase().includes(searchValue) :
              coin.name.toLowerCase().includes(searchValue) || coin.symbol.toLowerCase().includes(searchValue);
            const matchesCategory = category ? coin.category === category : true;
            const matchesStablecoins = settings.showStablecoins || coin.category !== 'stablecoin';
            const matchesMemeCoins = settings.showMemeCoins || coin.category !== 'meme';
            return matchesSearch && matchesCategory && matchesStablecoins && matchesMemeCoins;
          });
          await fetchContractAddresses(filteredData);
        }
        store.setState({ filteredData, currentPage });
        sortTable(sortColumn, false);
        document.getElementById('crypto-table').classList.remove('loading');
      }, debounceTime);
    }

    function sortTable(column, toggle = true) {
      if (toggle) {
        document.querySelectorAll('th').forEach(th => {
          th.classList.remove('sorted', 'desc');
        });
        const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
        if (sortColumn === column) {
          sortDirection *= -1;
          if (sortDirection === -1) th.classList.add('sorted', 'desc');
          else th.classList.add('sorted');
        } else {
          sortColumn = column;
          sortDirection = 1;
          th.classList.add('sorted');
        }
      }
      filteredData.sort((a, b) => {
        let valueA, valueB;
        switch (column) {
          case 'cmc_rank': valueA = a.cmc_rank || Infinity; valueB = b.cmc_rank || Infinity; break;
          case 'name': valueA = a.name.toLowerCase(); valueB = b.name.toLowerCase(); break;
          case 'price': valueA = a.quote.BRL.price || 0; valueB = b.quote.BRL.price || 0; break;
          case 'market_cap': valueA = a.quote.BRL.market_cap || 0; valueB = b.quote.BRL.market_cap || 0; break;
          case 'market_cap_dominance': valueA = a.quote.BRL.market_cap_dominance || 0; valueB = b.quote.BRL.market_cap_dominance || 0; break;
        }
        if (typeof valueA === 'string') return sortDirection * valueA.localeCompare(valueB);
        return sortDirection * (valueA - valueB);
      });
      store.setState({ filteredData });
      renderTable(getPageData());
      updatePagination();
    }

    async function showModal(coinId, coinSlug) {
      try {
        let coin = cryptoData.find(c => c.id === coinId);
        if (!coin) throw new Error('Moeda não encontrada na lista de dados.');
        let coinInfo = {};
        if (coinId.startsWith('coinmarketcap')) {
          const cmcId = coinId.split('-')[1];
          try {
            const res = await fetch(`https://pro-api.coinmarketcap.com/v1/cryptocurrency/info?id=${cmcId}`, {
              headers: { "X-CMC_PRO_API_KEY": cmcApiKey }
            });
            if (!res.ok) throw new Error(`Erro ao buscar detalhes: ${res.status} ${res.statusText}`);
            const data = await res.json();
            coinInfo = data.data[cmcId] || {};
          } catch (err) {
            console.warn('Erro ao buscar dados do CoinMarketCap:', err.message);
            coinInfo = { urls: { website: [] } };
          }
        } else {
          try {
            const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coinSlug}`);
            if (!res.ok) throw new Error(`Erro ao buscar detalhes: ${res.status} ${res.statusText}`);
            coinInfo = await res.json();
          } catch (err) {
            console.warn('Erro ao buscar dados do CoinGecko:', err.message);
            coinInfo = { links: { homepage: [] } };
          }
        }

        document.getElementById('modal-title').textContent = `${coin.name} (${coin.symbol})`;
        document.getElementById('modal-price').innerHTML = `${translations[localStorage.getItem('language') || 'pt'].price_label}${formatPrice(coin.quote.BRL.price) || 'R$ N/A'}`;
        document.getElementById('modal-market-cap').textContent = `${translations[localStorage.getItem('language') || 'pt'].market_cap_label}${coin.quote.BRL.market_cap ?
          `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}` : 'N/A'}`;
        document.getElementById('modal-dominance').textContent = `${translations[localStorage.getItem('language') || 'pt'].dominance_label}${coin.quote.BRL.market_cap_dominance ?
          `${coin.quote.BRL.market_cap_dominance.toFixed(2)}%` : 'N/A'}`;
        document.getElementById('modal-contract').innerHTML = `${translations[localStorage.getItem('language') || 'pt'].contract_label}${coin.contract_address ?
          `<a href="https://etherscan.io/address/${coin.contract_address}" target="_blank">${coin.contract_address}</a>` :
          translations[localStorage.getItem('language') || 'pt'].not_available}`;
        document.getElementById('modal-website').innerHTML = `${translations[localStorage.getItem('language') || 'pt'].website_label}${coinInfo.urls?.website?.[0] || coinInfo.links?.homepage?.[0] ?
          `<a href="${coinInfo.urls.website?.[0] || coinInfo.links.homepage[0]}" target="_blank">${coinInfo.urls.website?.[0] || coinInfo.links.homepage[0]}</a>` :
          translations[localStorage.getItem('language') || 'pt'].not_available}`;

        let historicalData;
        try {
          const cgRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinSlug}/market_chart?vs_currency=brl&days=7`);
          if (!cgRes.ok) throw new Error(`Erro ao buscar gráfico: ${cgRes.status} ${res.statusText}`);
          historicalData = await cgRes.json();
        } catch (err) {
          console.error('Erro ao carregar dados históricos:', err.message);
          historicalData = mockHistoricalData;
          document.getElementById('modal-chart-error').style.display = 'block';
          document.getElementById('modal-chart-error').textContent = translations[localStorage.getItem('language') || 'pt'].chart_error;
        }

        const prices = historicalData.prices;
        const firstPrice = prices[0][1];
        const lastPrice = prices[prices.length - 1][1];
        const isUp = lastPrice >= firstPrice;
        const lineColor = isUp ? '#22c55e' : '#ef4444';
        const fillColor = isUp ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        const ctx = document.getElementById('modal-chart').getContext('2d');
        if (priceChart) priceChart.destroy();
        priceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: prices.map(p => new Date(p[0]).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })),
            datasets: [{
              label: translations[localStorage.getItem('language') || 'pt'].chart_label || 'Preço (BRL) - Últimos 7 Dias',
              data: prices.map(p => p[1]),
              borderColor: lineColor,
              backgroundColor: fillColor,
              fill: true,
              tension: 0.4,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { grid: { display: false }, ticks: { color: '#9ca3af' } },
              y: { grid: { color: '#2d2d31' }, ticks: { color: '#9ca3af', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } }
            },
            plugins: {
              legend: { display: true, labels: { color: 'var(--text-color)' } },
              tooltip: {
                backgroundColor: 'var(--card-bg)',
                titleColor: 'var(--text-color)',
                bodyColor: 'var(--text-color)',
                callbacks: { label: context => `R$ ${context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` }
              }
            }
          }
        });
        document.getElementById('modal-chart-error').style.display = 'none';
        document.getElementById('modal').style.display = 'flex';
        const modalContent = document.querySelector('.modal-content');
        modalContent.focus();
        trapFocus(modalContent);
      } catch (err) {
        console.error('Erro ao carregar detalhes da moeda:', err.message);
        alert(translations[localStorage.getItem('language') || 'pt'].modal_error || `Erro ao carregar detalhes da moeda: ${err.message}`);
      }
    }

    function trapFocus(element) {
      const focusable = element.querySelectorAll('a, button, input, select, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      element.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      });
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      if (priceChart) priceChart.destroy();
      document.getElementById('modal-chart-error').style.display = 'none';
    }

    function exportToCSV() {
      const headers = ['Rank', 'Moeda', 'Preço', 'Market Cap', 'Dominância'];
      const rows = filteredData.map(coin => [
        coin.cmc_rank || 'N/A',
        `${coin.name} (${coin.symbol})`,
        formatPrice(coin.quote.BRL.price) || 'N/A',
        coin.quote.BRL.market_cap?.toLocaleString('pt-BR') || 'N/A',
        coin.quote.BRL.market_cap_dominance?.toFixed(2) || 'N/A'
      ]);
      const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'crypto_data.csv';
      link.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem('language') || 'pt';
      changeLanguage(savedLang);
      document.querySelector('select').value = savedLang;
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      const lang = savedLang;
      const themeText = savedTheme === 'dark' ? translations[lang].theme : translations[lang].theme.replace('Escuro', 'Claro').replace('Dark', 'Light').replace('Oscuro', 'Claro').replace('Sombre', 'Clair').replace('Dunkles', 'Helles');
      document.querySelector('.theme-toggle span').textContent = themeText;
      const savedFontSize = localStorage.getItem('fontSize');
      if (savedFontSize) document.documentElement.style.fontSize = `${savedFontSize}px`;
      loadStatsPreferences();
      fetchCryptoData();
      store.subscribe(state => renderTable(getPageData()));
      document.querySelectorAll('.pagination button').forEach(button => {
        button.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            button.click();
          }
        });
      });
    });

    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('crypto-links');
      const icon = document.querySelector('.menu-icon');
      if (!dropdown.contains(e.target) && !icon.contains(e.target)) {
        dropdown.classList.remove('active');
        dropdown.setAttribute('aria-expanded', 'false');
      }
    });

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal')) closeModal();
    });

    setInterval(fetchCryptoData, 600000);
  </script>
</body>
</html>