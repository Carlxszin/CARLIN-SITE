// Traduções
const translations = {
  pt: {
    title: "CryptoPulse",
    theme_dark: "Tema Escuro",
    theme_light: "Tema Claro",
    portfolio: "Portfolio Pessoal",
    trackers: "Rastreador & Exploradores",
    settings: "Configurações",
    market_title: "Mercado de Criptomoedas",
    search_placeholder: "Pesquisar por nome ou símbolo...",
    search_button: "Buscar",
    previous: "Anterior",
    next: "Próximo",
    page: "Página {0}",
    rank: "#",
    coin: "Moeda",
    price: "Preço (24h)",
    market_cap: "Market Cap",
    dominance: "Dominância",
    loading: "Carregando...",
    price_label: "Preço: ",
    market_cap_label: "Market Cap: ",
    dominance_label: "Dominância: ",
    website_label: "Website: ",
    chart_error: "Erro ao carregar gráfico",
    chart_label: "Preço (BRL) - Últimos 7 Dias",
    footer: "© 2025 CryptoPulse | Dados: CoinGecko",
    not_available: "Não disponível",
    modal_error: "Erro ao carregar detalhes da moeda",
    total_market_cap: "Capitalização Total",
    volume_24h: "Volume 24h",
    btc_dominance: "Dominância do Bitcoin",
    no_results: "Nenhuma moeda encontrada",
    error_loading: "Erro ao carregar dados",
    all_categories: "Todas as Categorias",
    defi: "DeFi",
    meme: "Meme Coins",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2"
  },
  en: {
    title: "CryptoPulse",
    theme_dark: "Dark Theme",
    theme_light: "Light Theme",
    portfolio: "Personal Portfolio",
    trackers: "Trackers & Explorers",
    settings: "Settings",
    market_title: "Cryptocurrency Market",
    search_placeholder: "Search by name or symbol...",
    search_button: "Search",
    previous: "Previous",
    next: "Next",
    page: "Page {0}",
    rank: "#",
    coin: "Coin",
    price: "Price (24h)",
    market_cap: "Market Cap",
    dominance: "Dominance",
    loading: "Loading...",
    price_label: "Price: ",
    market_cap_label: "Market Cap: ",
    dominance_label: "Dominance: ",
    website_label: "Website: ",
    chart_error: "Error loading chart",
    chart_label: "Price (BRL) - Last 7 Days",
    footer: "© 2025 CryptoPulse | Data: CoinGecko",
    not_available: "Not available",
    modal_error: "Error loading coin details",
    total_market_cap: "Total Market Cap",
    volume_24h: "24h Volume",
    btc_dominance: "Bitcoin Dominance",
    no_results: "No coins found",
    error_loading: "Error loading data",
    all_categories: "All Categories",
    defi: "DeFi",
    meme: "Meme Coins",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2"
  },
  es: {
    title: "CryptoPulse",
    theme_dark: "Tema Oscuro",
    theme_light: "Tema Claro",
    portfolio: "Portafolio Personal",
    trackers: "Rastreadores y Exploradores",
    settings: "Configuraciones",
    market_title: "Mercado de Criptomonedas",
    search_placeholder: "Buscar por nombre o símbolo...",
    search_button: "Buscar",
    previous: "Anterior",
    next: "Siguiente",
    page: "Página {0}",
    rank: "#",
    coin: "Moneda",
    price: "Precio (24h)",
    market_cap: "Capitalización de Mercado",
    dominance: "Dominancia",
    loading: "Cargando...",
    price_label: "Precio: ",
    market_cap_label: "Capitalización de Mercado: ",
    dominance_label: "Dominancia: ",
    website_label: "Sitio Web: ",
    chart_error: "Error al cargar el gráfico",
    chart_label: "Precio (BRL) - Últimos 7 Días",
    footer: "© 2025 CryptoPulse | Datos: CoinGecko",
    not_available: "No disponible",
    modal_error: "Error al cargar detalles de la moneda",
    total_market_cap: "Capitalización Total",
    volume_24h: "Volumen 24h",
    btc_dominance: "Dominancia de Bitcoin",
    no_results: "No se encontraron monedas",
    error_loading: "Error al cargar datos",
    all_categories: "Todas las Categorías",
    defi: "DeFi",
    meme: "Monedas Meme",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2"
  },
  fr: {
    title: "CryptoPulse",
    theme_dark: "Thème Sombre",
    theme_light: "Thème Clair",
    portfolio: "Portefeuille Personnel",
    trackers: "Traqueurs & Explorateurs",
    settings: "Paramètres",
    market_title: "Marché des Cryptomonnaies",
    search_placeholder: "Rechercher par nom ou symbole...",
    search_button: "Rechercher",
    previous: "Précédent",
    next: "Suivant",
    page: "Page {0}",
    rank: "#",
    coin: "Monnaie",
    price: "Prix (24h)",
    market_cap: "Capitalisation Boursière",
    dominance: "Dominance",
    loading: "Chargement...",
    price_label: "Prix : ",
    market_cap_label: "Capitalisation Boursière : ",
    dominance_label: "Dominance : ",
    website_label: "Site Web : ",
    chart_error: "Erreur lors du chargement du graphique",
    chart_label: "Prix (BRL) - 7 Derniers Jours",
    footer: "© 2025 CryptoPulse | Données : CoinGecko",
    not_available: "Non disponible",
    modal_error: "Erreur lors du chargement des détails de la monnaie",
    total_market_cap: "Capitalisation Totale",
    volume_24h: "Volume 24h",
    btc_dominance: "Dominance de Bitcoin",
    no_results: "Aucune monnaie trouvée",
    error_loading: "Erreur lors du chargement des données",
    all_categories: "Toutes les Catégories",
    defi: "DeFi",
    meme: "Monnaies Mème",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2"
  },
  de: {
    title: "CryptoPulse",
    theme_dark: "Dunkles Thema",
    theme_light: "Helles Thema",
    portfolio: "Persönliches Portfolio",
    trackers: "Tracker & Explorer",
    settings: "Einstellungen",
    market_title: "Kryptowährungsmarkt",
    search_placeholder: "Nach Name oder Symbol suchen...",
    search_button: "Suchen",
    previous: "Zurück",
    next: "Weiter",
    page: "Seite {0}",
    rank: "#",
    coin: "Münze",
    price: "Preis (24h)",
    market_cap: "Marktkapitalisierung",
    dominance: "Dominanz",
    loading: "Laden...",
    price_label: "Preis: ",
    market_cap_label: "Marktkapitalisierung: ",
    dominance_label: "Dominanz: ",
    website_label: "Website: ",
    chart_error: "Fehler beim Laden des Diagramms",
    chart_label: "Preis (BRL) - Letzte 7 Tage",
    footer: "© 2025 CryptoPulse | Daten: CoinGecko",
    not_available: "Nicht verfügbar",
    modal_error: "Fehler beim Laden der Münzdetails",
    total_market_cap: "Gesamtmarktkapitalisierung",
    volume_24h: "24h-Volumen",
    btc_dominance: "Bitcoin-Dominanz",
    no_results: "Keine Münzen gefunden",
    error_loading: "Fehler beim Laden der Daten",
    all_categories: "Alle Kategorien",
    defi: "DeFi",
    meme: "Meme-Münzen",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2"
  }
};

// Configurações da API
const cgApiBaseUrl = 'https://api.coingecko.com/api/v3';
const cgCoinsListUrl = `${cgApiBaseUrl}/coins/list`;
const cgMarketsUrl = `${cgApiBaseUrl}/coins/markets`;
const cgGlobalUrl = `${cgApiBaseUrl}/global`;
let allCoinsList = [];
let cryptoData = [];
let filteredData = [];
let sortColumn = 'cmc_rank';
let sortDirection = 1;
let currentPage = 1;
const itemsPerPage = 20;
let priceChart = null;
let debounceTimeout;
let totalMarketCap = 0;

// Dados de teste (30 moedas, com dominância corrigida)
const mockData = [
  { id: "bitcoin", name: "Bitcoin", symbol: "BTC", cmc_rank: 1, current_price: 350000, price_change_percentage_24h: 2.5, market_cap: 7000000000000, market_cap_dominance: (7000000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png' },
  { id: "ethereum", name: "Ethereum", symbol: "ETH", cmc_rank: 2, current_price: 15000, price_change_percentage_24h: -1.2, market_cap: 1800000000000, market_cap_dominance: (1800000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png' },
  { id: "tether", name: "Tether", symbol: "USDT", cmc_rank: 3, current_price: 5.5, price_change_percentage_24h: 0.1, market_cap: 150000000000, market_cap_dominance: (150000000000 / 9000000000000) * 100, category: 'stablecoin', image: 'https://assets.coingecko.com/coins/images/325/small/Tether.png' },
  { id: "binancecoin", name: "Binance Coin", symbol: "BNB", cmc_rank: 4, current_price: 3000, price_change_percentage_24h: 1.8, market_cap: 450000000000, market_cap_dominance: (450000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/825/small/binance-coin-logo.png' },
  { id: "solana", name: "Solana", symbol: "SOL", cmc_rank: 5, current_price: 800, price_change_percentage_24h: 3.2, market_cap: 300000000000, market_cap_dominance: (300000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/4128/small/solana.png' },
  { id: "ripple", name: "XRP", symbol: "XRP", cmc_rank: 6, current_price: 3.5, price_change_percentage_24h: -0.5, market_cap: 200000000000, market_cap_dominance: (200000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png' },
  { id: "cardano", name: "Cardano", symbol: "ADA", cmc_rank: 7, current_price: 2.8, price_change_percentage_24h: 2.1, market_cap: 100000000000, market_cap_dominance: (100000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/975/small/cardano.png' },
  { id: "avalanche-2", name: "Avalanche", symbol: "AVAX", cmc_rank: 8, current_price: 200, price_change_percentage_24h: -2.3, market_cap: 80000000000, market_cap_dominance: (80000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/12559/small/avalanche.png' },
  { id: "dogecoin", name: "Dogecoin", symbol: "DOGE", cmc_rank: 9, current_price: 0.75, price_change_percentage_24h: 4.0, market_cap: 70000000000, market_cap_dominance: (70000000000 / 9000000000000) * 100, category: 'meme', image: 'https://assets.coingecko.com/coins/images/5/small/dogecoin.png' },
  { id: "chainlink", name: "Chainlink", symbol: "LINK", cmc_rank: 10, current_price: 80, price_change_percentage_24h: 1.5, market_cap: 60000000000, market_cap_dominance: (60000000000 / 9000000000000) * 100, category: 'defi', image: 'https://assets.coingecko.com/coins/images/877/small/chainlink-new-logo.png' },
  { id: "polkadot", name: "Polkadot", symbol: "DOT", cmc_rank: 11, current_price: 35, price_change_percentage_24h: 0.8, market_cap: 50000000000, market_cap_dominance: (50000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/12171/small/polkadot.png' },
  { id: "matic-network", name: "Polygon", symbol: "MATIC", cmc_rank: 12, current_price: 2.5, price_change_percentage_24h: -1.0, market_cap: 40000000000, market_cap_dominance: (40000000000 / 9000000000000) * 100, category: 'layer-2', image: 'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png' },
  { id: "shiba-inu", name: "Shiba Inu", symbol: "SHIB", cmc_rank: 13, current_price: 0.0001, price_change_percentage_24h: 5.2, market_cap: 35000000000, market_cap_dominance: (35000000000 / 9000000000000) * 100, category: 'meme', image: 'https://assets.coingecko.com/coins/images/11939/small/shiba.png' },
  { id: "uniswap", name: "Uniswap", symbol: "UNI", cmc_rank: 14, current_price: 40, price_change_percentage_24h: 2.7, market_cap: 30000000000, market_cap_dominance: (30000000000 / 9000000000000) * 100, category: 'defi', image: 'https://assets.coingecko.com/coins/images/12504/small/uniswap-uni.png' },
  { id: "near", name: "NEAR Protocol", symbol: "NEAR", cmc_rank: 15, current_price: 30, price_change_percentage_24h: -0.9, market_cap: 28000000000, market_cap_dominance: (28000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/10365/small/near_icon.png' },
  { id: "wrapped-bitcoin", name: "Wrapped Bitcoin", symbol: "WBTC", cmc_rank: 16, current_price: 349000, price_change_percentage_24h: 2.4, market_cap: 25000000000, market_cap_dominance: (25000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/7598/small/wrapped_bitcoin_wbtc.png' },
  { id: "filecoin", name: "Filecoin", symbol: "FIL", cmc_rank: 17, current_price: 25, price_change_percentage_24h: 1.1, market_cap: 22000000000, market_cap_dominance: (22000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/12817/small/filecoin.png' },
  { id: "fantom", name: "Fantom", symbol: "FTM", cmc_rank: 18, current_price: 4.5, price_change_percentage_24h: 3.5, market_cap: 20000000000, market_cap_dominance: (20000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/4001/small/Fantom.png' },
  { id: "hedera-hashgraph", name: "Hedera", symbol: "HBAR", cmc_rank: 19, current_price: 0.5, price_change_percentage_24h: -1.5, market_cap: 18000000000, market_cap_dominance: (18000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/3688/small/hbar.png' },
  { id: "vechain", name: "VeChain", symbol: "VET", cmc_rank: 20, current_price: 0.15, price_change_percentage_24h: 0.6, market_cap: 15000000000, market_cap_dominance: (15000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/1167/small/VeChain-Logo.png' },
  { id: "tezos", name: "Tezos", symbol: "XTZ", cmc_rank: 21, current_price: 5, price_change_percentage_24h: -0.7, market_cap: 14000000000, market_cap_dominance: (14000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/976/small/Tezos-logo.png' },
  { id: "huobi-token", name: "Huobi Token", symbol: "HT", cmc_rank: 22, current_price: 3, price_change_percentage_24h: 1.2, market_cap: 13000000000, market_cap_dominance: (13000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/2822/small/huobi-token-logo.png' },
  { id: "iota", name: "IOTA", symbol: "IOTA", cmc_rank: 23, current_price: 0.8, price_change_percentage_24h: 2.0, market_cap: 12000000000, market_cap_dominance: (12000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/692/small/IOTA_Swirl.png' },
  { id: "ontology", name: "Ontology", symbol: "ONT", cmc_rank: 24, current_price: 1.2, price_change_percentage_24h: -0.3, market_cap: 11000000000, market_cap_dominance: (11000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/3447/small/ONT.png' },
  { id: "zilliqa", name: "Zilliqa", symbol: "ZIL", cmc_rank: 25, current_price: 0.1, price_change_percentage_24h: 1.8, market_cap: 10000000000, market_cap_dominance: (10000000000 / 9000000000000) * 100, category: 'layer-1', image: 'https://assets.coingecko.com/coins/images/2283/small/zilliqa-logo.png' },
  { id: "omisego", name: "OMG Network", symbol: "OMG", cmc_rank: 26, current_price: 2, price_change_percentage_24h: -1.1, market_cap: 9000000000, market_cap_dominance: (9000000000 / 9000000000000) * 100, category: 'layer-2', image: 'https://assets.coingecko.com/coins/images/776/small/OMG_Network.jpg' },
  { id: "holo", name: "Holo", symbol: "HOT", cmc_rank: 27, current_price: 0.01, price_change_percentage_24h: 3.0, market_cap: 8000000000, market_cap_dominance: (8000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/3348/small/Holo.png' },
  { id: "0x", name: "0x", symbol: "ZRX", cmc_rank: 28, current_price: 1.5, price_change_percentage_24h: 0.5, market_cap: 7000000000, market_cap_dominance: (7000000000 / 9000000000000) * 100, category: 'defi', image: 'https://assets.coingecko.com/coins/images/863/small/0x.png' },
  { id: "enjincoin", name: "Enjin Coin", symbol: "ENJ", cmc_rank: 29, current_price: 1, price_change_percentage_24h: 2.3, market_cap: 6000000000, market_cap_dominance: (6000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/1102/small/enjin-coin-logo.png' },
  { id: "status", name: "Status", symbol: "SNT", cmc_rank: 30, current_price: 0.2, price_change_percentage_24h: -0.8, market_cap: 5000000000, market_cap_dominance: (5000000000 / 9000000000000) * 100, category: '', image: 'https://assets.coingecko.com/coins/images/779/small/status.png' }
];

const mockGlobalData = {
  total_market_cap: { brl: 9000000000000 },
  total_volume: { brl: 500000000000 },
  market_cap_percentage: { btc: 50 }
};

const mockHistoricalData = {
  prices: Array.from({ length: 7 }, (_, i) => [Date.now() - (6 - i) * 24 * 60 * 60 * 1000, 340000 + i * 2000])
};

function sanitizeInput(input) {
  return input.replace(/[<>]/g, '').trim();
}

function formatPrice(price) {
  if (!price || isNaN(price)) return translations[localStorage.getItem('language') || 'pt'].not_available;
  return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 6 })}`;
}

async function fetchCoinsList() {
  const cached = localStorage.getItem('coinsList');
  if (cached) {
    allCoinsList = JSON.parse(cached);
    if (allCoinsList.length > 0) return;
  }
  try {
    const res = await fetch(cgCoinsListUrl);
    if (!res.ok) throw new Error('Erro na API CoinGecko /coins/list');
    allCoinsList = await res.json();
    localStorage.setItem('coinsList', JSON.stringify(allCoinsList));
    console.log(`Lista de moedas carregada: ${allCoinsList.length} moedas`);
  } catch (err) {
    console.error('Erro ao carregar lista de moedas:', err.message);
    allCoinsList = mockData.map(coin => ({ id: coin.id, name: coin.name, symbol: coin.symbol }));
  }
}

async function fetchCgMarkets(ids = [], page = 1) {
  try {
    console.log(`Buscando mercados com totalMarketCap: ${totalMarketCap}`);
    const params = new URLSearchParams({
      vs_currency: 'brl',
      ids: ids.join(','),
      order: 'market_cap_desc',
      per_page: ids.length || 250,
      page,
      sparkline: false
    });
    const url = ids.length ? `${cgMarketsUrl}?${params}` : `${cgMarketsUrl}?vs_currency=brl&order=market_cap_desc&per_page=10&page=1&sparkline=false`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Erro na API CoinGecko /coins/markets');
    const data = await res.json();
    return data.map(coin => {
      const dominance = totalMarketCap && coin.market_cap ? (coin.market_cap / totalMarketCap) * 100 : 0;
      console.log(`Moeda: ${coin.name}, Market Cap: ${coin.market_cap}, Dominância: ${dominance.toFixed(2)}%`);
      return {
        id: coin.id,
        name: coin.name,
        symbol: coin.symbol.toUpperCase(),
        slug: coin.id,
        cmc_rank: coin.market_cap_rank || Infinity,
        quote: {
          BRL: {
            price: coin.current_price || 0,
            percent_change_24h: coin.price_change_percentage_24h || 0,
            market_cap: coin.market_cap || 0,
            market_cap_dominance: dominance
          }
        },
        category: coin.categories?.some(cat => cat?.toLowerCase().includes('defi')) ? 'defi' :
                  coin.categories?.some(cat => cat?.toLowerCase().includes('meme')) ? 'meme' :
                  coin.categories?.some(cat => cat?.toLowerCase().includes('stablecoin')) ? 'stablecoin' :
                  coin.categories?.some(cat => cat?.toLowerCase().includes('layer-1')) ? 'layer-1' :
                  coin.categories?.some(cat => cat?.toLowerCase().includes('layer-2')) ? 'layer-2' : '',
        image: coin.image || 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png'
      };
    });
  } catch (err) {
    console.error('Erro CoinGecko /coins/markets:', err.message);
    throw err;
  }
}

async function fetchCgGlobalData() {
  try {
    const res = await fetch(cgGlobalUrl);
    if (!res.ok) throw new Error('Erro na API CoinGecko /global');
    const data = await res.json();
    totalMarketCap = data.data.total_market_cap.brl || 0;
    console.log(`Total Market Cap carregado: ${totalMarketCap}`);
    return {
      total_market_cap: totalMarketCap,
      total_volume_24h: data.data.total_volume.brl || 0,
      btc_dominance: data.data.market_cap_percentage?.btc || 0
    };
  } catch (err) {
    console.error('Erro Global:', err.message);
    totalMarketCap = mockGlobalData.total_market_cap.brl;
    return mockGlobalData;
  }
}

function changeLanguage(lang) {
  localStorage.setItem('language', lang);
  const translation = translations[lang] || translations.pt;

  document.querySelectorAll('[data-i18n]').forEach(elem => {
    const key = elem.getAttribute('data-i18n');
    if (translation[key]) {
      if (key === 'page') {
        const currentPage = document.getElementById('page-info').textContent.match(/\d+/)?.[0] || 1;
        elem.textContent = translation[key].replace('{0}', currentPage);
      } else {
        elem.textContent = translation[key];
      }
    }
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
    const key = elem.getAttribute('data-i18n-placeholder');
    if (translation[key]) elem.placeholder = translation[key];
  });

  document.querySelectorAll('[data-i18n-prefix]').forEach(elem => {
    const key = elem.getAttribute('data-i18n-prefix');
    const currentText = elem.textContent.split(': ').slice(1).join(': ');
    if (translation[key]) elem.textContent = translation[key] + currentText;
  });
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  const themeSpan = document.querySelector('.theme-toggle span');
  themeSpan.setAttribute('data-i18n', newTheme === 'dark' ? 'theme_dark' : 'theme_light');
  changeLanguage(localStorage.getItem('language') || 'pt');
}

function toggleDropdown() {
  const dropdown = document.getElementById('crypto-links');
  dropdown.classList.toggle('active');
}

async function updateMarketStats() {
  const stats = document.getElementById('market-stats');
  stats.classList.add('loading');
  const globalData = await fetchCgGlobalData();
  stats.classList.remove('loading');
  document.getElementById('total-market-cap').textContent = globalData.total_market_cap ?
    `R$ ${globalData.total_market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[localStorage.getItem('language') || 'pt'].not_available;
  document.getElementById('volume-24h').textContent = globalData.total_volume_24h ?
    `R$ ${globalData.total_volume_24h.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[localStorage.getItem('language') || 'pt'].not_available;
  document.getElementById('btc-dominance').textContent = globalData.btc_dominance ?
    `${globalData.btc_dominance.toFixed(2)}%` : translations[localStorage.getItem('language') || 'pt'].not_available;
}

async function fetchCryptoData() {
  const table = document.getElementById('crypto-table');
  table.classList.add('loading');
  try {
    await fetchCoinsList();
    await updateMarketStats(); // Carrega totalMarketCap primeiro
    cryptoData = await fetchCgMarkets();
    filteredData = cryptoData.slice(0, 10); // Top 10
    renderTable(filteredData);
  } catch (err) {
    console.warn('Usando dados de teste devido a falha na API');
    cryptoData = mockData;
    filteredData = mockData.slice(0, 10);
    totalMarketCap = mockGlobalData.total_market_cap.brl;
    document.querySelector("#crypto-table tbody").innerHTML =
      `<tr><td colspan="5" class="error-message" data-i18n="error_loading">Erro ao carregar dados. Usando dados de teste.</td></tr>`;
    renderTable(filteredData);
    await updateMarketStats();
  } finally {
    table.classList.remove('loading');
  }
}

function getPageData(data) {
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  return data.slice(start, end);
}

function updatePagination(data) {
  const totalPages = Math.ceil(data.length / itemsPerPage);
  document.getElementById('prev-page').disabled = currentPage === 1;
  document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
  const lang = localStorage.getItem('language') || 'pt';
  document.getElementById('page-info').textContent = translations[lang].page.replace('{0}', currentPage);
  document.getElementById('pagination').style.display = data.length > itemsPerPage ? 'flex' : 'none';
}

function changePage(delta) {
  const totalPages = Math.ceil(filteredData.length / itemsPerPage);
  currentPage = Math.min(Math.max(1, currentPage + delta), totalPages);
  renderTable(filteredData);
}

function renderTable(data) {
  const tbody = document.querySelector("#crypto-table tbody");
  const pageData = getPageData(data);
  tbody.innerHTML = pageData.length ? '' : `<tr><td colspan="5" class="no-results" data-i18n="no_results">Nenhuma moeda encontrada.</td></tr>`;
  pageData.forEach(coin => {
    const changeClass = (coin.quote.BRL.percent_change_24h || 0) >= 0 ? "positive" : "negative";
    const dominance = coin.quote.BRL.market_cap_dominance && !isNaN(coin.quote.BRL.market_cap_dominance) ? 
      `${coin.quote.BRL.market_cap_dominance.toFixed(2)}%` : translations[localStorage.getItem('language') || 'pt'].not_available;
    console.log(`Renderizando ${coin.name}: Dominância = ${dominance}`);
    tbody.innerHTML += `
      <tr onclick="showModal('${coin.id}', '${coin.slug}')">
        <td>${coin.cmc_rank || translations[localStorage.getItem('language') || 'pt'].not_available}</td>
        <td><img src="${coin.image}" class="coin-icon" alt="${coin.name}" loading="lazy" onerror="this.src='https://assets.coingecko.com/coins/images/1/small/bitcoin.png'">${coin.name} (${coin.symbol})</td>
        <td>${formatPrice(coin.quote.BRL.price)}<br><span class="${changeClass}">${(coin.quote.BRL.percent_change_24h || 0).toFixed(2)}%</span></td>
        <td>${coin.quote.BRL.market_cap ? `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[localStorage.getItem('language') || 'pt'].not_available}</td>
        <td>${dominance}</td>
      </tr>
    `;
  });
  updatePagination(data);
  changeLanguage(localStorage.getItem('language') || 'pt');
}

async function filterTable() {
  const searchValue = sanitizeInput(document.getElementById("search-input").value.toLowerCase());
  const category = document.getElementById("category-filter").value;
  
  if (!searchValue) {
    filteredData = cryptoData.slice(0, 10); // Voltar ao top 10 se a busca estiver vazia
    currentPage = 1;
    sortTable(sortColumn, false);
    return;
  }

  const matchedCoins = allCoinsList.filter(coin =>
    coin.name.toLowerCase().includes(searchValue) ||
    coin.symbol.toLowerCase().includes(searchValue)
  );

  console.log(`Busca: "${searchValue}", categoria: "${category}", moedas encontradas: ${matchedCoins.length}`);

  if (matchedCoins.length === 0) {
    filteredData = [];
    renderTable(filteredData);
    return;
  }

  const coinIds = matchedCoins.map(coin => coin.id);
  filteredData = [];
  let page = 1;
  const maxPages = Math.ceil(matchedCoins.length / 250);

  try {
    await updateMarketStats(); // Carrega totalMarketCap antes da busca
    while (page <= maxPages && filteredData.length < matchedCoins.length) {
      const batchIds = coinIds.slice((page - 1) * 250, page * 250);
      if (batchIds.length === 0) break;
      const batchData = await fetchCgMarkets(batchIds, page);
      filteredData.push(...batchData.filter(coin => 
        (!category || (coin.category || '') === category)
      ));
      page++;
    }
  } catch (err) {
    console.error('Erro ao buscar dados de mercado:', err.message);
    filteredData = mockData.filter(coin =>
      (coin.name.toLowerCase().includes(searchValue) ||
       coin.symbol.toLowerCase().includes(searchValue)) &&
      (!category || (coin.category || '') === category)
    );
  }

  console.log(`Resultados após filtro: ${filteredData.length}`);
  currentPage = 1;
  sortTable(sortColumn, false);
}

function debounceFilter() {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(filterTable, 300);
}

function sortTable(column, toggle = true) {
  if (toggle) {
    document.querySelectorAll('th').forEach(th => th.classList.remove('sorted', 'desc'));
    const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
    sortColumn = column;
    sortDirection = sortColumn === column ? sortDirection * -1 : 1;
    th.classList.add('sorted', sortDirection === -1 ? 'desc' : '');
  }
  filteredData.sort((a, b) => {
    let valueA, valueB;
    switch (column) {
      case 'cmc_rank': valueA = a.cmc_rank || Infinity; valueB = b.cmc_rank || Infinity; break;
      case 'name': valueA = (a.name || '').toLowerCase(); valueB = (b.name || '').toLowerCase(); break;
      case 'price': valueA = a.quote.BRL.price || 0; valueB = b.quote.BRL.price || 0; break;
      case 'market_cap': valueA = a.quote.BRL.market_cap || 0; valueB = b.quote.BRL.market_cap || 0; break;
      case 'market_cap_dominance': valueA = a.quote.BRL.market_cap_dominance || 0; valueB = b.quote.BRL.market_cap_dominance || 0; break;
    }
    return typeof valueA === 'string' ? sortDirection * valueA.localeCompare(valueB) : sortDirection * (valueA - valueB);
  });
  renderTable(filteredData);
}

async function showModal(coinId, coinSlug) {
  const coin = filteredData.find(c => c.id === coinId) || cryptoData.find(c => c.id === coinId);
  if (!coin) return;
  const lang = localStorage.getItem('language') || 'pt';
  document.getElementById('modal-title').textContent = `${coin.name} (${coin.symbol})`;
  document.getElementById('modal-price').textContent = `${translations[lang].price_label}${formatPrice(coin.quote.BRL.price)}`;
  document.getElementById('modal-market-cap').textContent = `${translations[lang].market_cap_label}${coin.quote.BRL.market_cap ?
    `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[lang].not_available}`;
  document.getElementById('modal-dominance').textContent = `${translations[lang].dominance_label}${coin.quote.BRL.market_cap_dominance && !isNaN(coin.quote.BRL.market_cap_dominance) ?
    `${coin.quote.BRL.market_cap_dominance.toFixed(2)}%` : translations[lang].not_available}`;
  document.getElementById('modal-website').innerHTML = `${translations[lang].website_label}<a href="https://www.${coin.slug}.org" target="_blank">www.${coin.slug}.org</a>`;

  let historicalData = mockHistoricalData;
  try {
    const res = await fetch(`${cgApiBaseUrl}/coins/${coinSlug}/market_chart?vs_currency=brl&days=7`);
    historicalData = await res.json();
    if (!res.ok) throw new Error('Erro ao carregar gráfico');
  } catch (err) {
    document.getElementById('modal-chart-error').style.display = 'block';
  }

  const ctx = document.getElementById('modal-chart').getContext('2d');
  if (priceChart) priceChart.destroy();
  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: historicalData.prices.map(p => new Date(p[0]).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' })),
      datasets: [{
        label: translations[lang].chart_label,
        data: historicalData.prices.map(p => p[1]),
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#9ca3af' } },
        y: { ticks: { color: '#9ca3af', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } }
      },
      plugins: {
        legend: { labels: { color: 'var(--text-color)' } },
        tooltip: { callbacks: { label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` } }
      }
    }
  });
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  if (priceChart) priceChart.destroy();
  document.getElementById('modal-chart-error').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  const savedLang = localStorage.getItem('language') || 'pt';
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  document.querySelector('.theme-toggle span').setAttribute('data-i18n', savedTheme === 'dark' ? 'theme_dark' : 'theme_light');
  document.getElementById('language-select').value = savedLang;
  changeLanguage(savedLang);
  fetchCryptoData();
});

document.addEventListener('click', e => {
  const dropdown = document.getElementById('crypto-links');
  if (!dropdown.contains(e.target) && !document.querySelector('.menu-icon').contains(e.target)) {
    dropdown.classList.remove('active');
  }
});

document.getElementById('modal').addEventListener('click', e => {
  if (e.target === document.getElementById('modal')) closeModal();
});