// Traduções
const translations = {
  pt: {
    title: "CryptoPulse",
    theme_dark: "Tema Escuro",
    theme_light: "Tema Claro",
    portfolio: "Portfolio Pessoal",
    trackers: "Rastreador & Exploradores",
    settings: "Configurações",
    market_title: "Mercado de Criptomoedas",
    search_placeholder: "Pesquisar por nome ou símbolo...",
    search_button: "Buscar",
    previous: "Anterior",
    next: "Próximo",
    page: "Página {0}",
    rank: "#",
    coin: "Moeda",
    price: "Preço (24h)",
    market_cap: "Market Cap",
    dominance: "Dominância",
    loading: "Carregando...",
    loading_stats: "Carregando dados reais...",
    loading_table: "Carregando moedas...",
    price_label: "Preço: ",
    market_cap_label: "Market Cap: ",
    dominance_label: "Dominância: ",
    website_label: "Website: ",
    chart_error: "Erro ao carregar gráfico",
    chart_label: "Preço (BRL) - Últimos 7 Dias",
    footer: "© 2025 CryptoPulse | Dados: CoinGecko",
    not_available: "Não disponível",
    modal_error: "Erro ao carregar detalhes da moeda",
    total_market_cap: "Capitalização Total",
    volume_24h: "Volume 24h",
    btc_dominance: "Dominância do Bitcoin",
    no_results: "Nenhuma moeda encontrada",
    error_loading: "Erro ao carregar dados. Tente novamente mais tarde.",
    all_categories: "Todas as Categorias",
    defi: "DeFi",
    meme: "Meme Coins",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2",
    cached_data: "Dados em cache",
    api_error: "Erro na API, usando dados em cache"
  },
  en: {
    title: "CryptoPulse",
    theme_dark: "Dark Theme",
    theme_light: "Light Theme",
    portfolio: "Personal Portfolio",
    trackers: "Trackers & Explorers",
    settings: "Settings",
    market_title: "Cryptocurrency Market",
    search_placeholder: "Search by name or symbol...",
    search_button: "Search",
    previous: "Previous",
    next: "Next",
    page: "Page {0}",
    rank: "#",
    coin: "Coin",
    price: "Price (24h)",
    market_cap: "Market Cap",
    dominance: "Dominance",
    loading: "Loading...",
    loading_stats: "Loading real-time data...",
    loading_table: "Loading coins...",
    price_label: "Price: ",
    market_cap_label: "Market Cap: ",
    dominance_label: "Dominance: ",
    website_label: "Website: ",
    chart_error: "Error loading chart",
    chart_label: "Price (BRL) - Last 7 Days",
    footer: "© 2025 CryptoPulse | Data: CoinGecko",
    not_available: "Not available",
    modal_error: "Error loading coin details",
    total_market_cap: "Total Market Cap",
    volume_24h: "24h Volume",
    btc_dominance: "Bitcoin Dominance",
    no_results: "No coins found",
    error_loading: "Error loading data. Please try again later.",
    all_categories: "All Categories",
    defi: "DeFi",
    meme: "Meme Coins",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2",
    cached_data: "Cached Data",
    api_error: "API error, using cached data"
  },
  es: {
    title: "CryptoPulse",
    theme_dark: "Tema Oscuro",
    theme_light: "Tema Claro",
    portfolio: "Portafolio Personal",
    trackers: "Rastreadores y Exploradores",
    settings: "Configuraciones",
    market_title: "Mercado de Criptomonedas",
    search_placeholder: "Buscar por nombre o símbolo...",
    search_button: "Buscar",
    previous: "Anterior",
    next: "Siguiente",
    page: "Página {0}",
    rank: "#",
    coin: "Moneda",
    price: "Precio (24h)",
    market_cap: "Capitalización de Mercado",
    dominance: "Dominancia",
    loading: "Cargando...",
    loading_stats: "Cargando datos en tiempo real...",
    loading_table: "Cargando monedas...",
    price_label: "Precio: ",
    market_cap_label: "Capitalización de Mercado: ",
    dominance_label: "Dominancia: ",
    website_label: "Sitio Web: ",
    chart_error: "Error al cargar el gráfico",
    chart_label: "Precio (BRL) - Últimos 7 Días",
    footer: "© 2025 CryptoPulse | Datos: CoinGecko",
    not_available: "No disponible",
    modal_error: "Error al cargar detalles de la moneda",
    total_market_cap: "Capitalización Total",
    volume_24h: "Volumen 24h",
    btc_dominance: "Dominancia de Bitcoin",
    no_results: "No se encontraron monedas",
    error_loading: "Error al cargar datos. Intenta de nuevo más tarde.",
    all_categories: "Todas las Categorías",
    defi: "DeFi",
    meme: "Monedas Meme",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2",
    cached_data: "Datos en caché",
    api_error: "Error de API, usando datos en caché"
  },
  fr: {
    title: "CryptoPulse",
    theme_dark: "Thème Sombre",
    theme_light: "Thème Clair",
    portfolio: "Portefeuille Personnel",
    trackers: "Traqueurs & Explorateurs",
    settings: "Paramètres",
    market_title: "Marché des Cryptomonnaies",
    search_placeholder: "Rechercher par nom ou symbole...",
    search_button: "Rechercher",
    previous: "Précédent",
    next: "Suivant",
    page: "Page {0}",
    rank: "#",
    coin: "Monnaie",
    price: "Prix (24h)",
    market_cap: "Capitalisation Boursière",
    dominance: "Dominance",
    loading: "Chargement...",
    loading_stats: "Chargement des données en temps réel...",
    loading_table: "Chargement des monnaies...",
    price_label: "Prix : ",
    market_cap_label: "Capitalisation Boursière : ",
    dominance_label: "Dominance : ",
    website_label: "Site Web : ",
    chart_error: "Erreur lors du chargement du graphique",
    chart_label: "Prix (BRL) - 7 Derniers Jours",
    footer: "© 2025 CryptoPulse | Données : CoinGecko",
    not_available: "Non disponible",
    modal_error: "Erreur lors du chargement des détails de la monnaie",
    total_market_cap: "Capitalisation Totale",
    volume_24h: "Volume 24h",
    btc_dominance: "Dominance du Bitcoin",
    no_results: "Aucune monnaie trouvée",
    error_loading: "Erreur lors du chargement des données. Réessayez plus tard.",
    all_categories: "Toutes les Catégories",
    defi: "DeFi",
    meme: "Mèmes Coins",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2",
    cached_data: "Données en cache",
    api_error: "Erreur API, utilisation des données en cache"
  },
  de: {
    title: "CryptoPulse",
    theme_dark: "Dunkles Thema",
    theme_light: "Helles Thema",
    portfolio: "Persönliches Portfolio",
    trackers: "Tracker & Entdecker",
    settings: "Einstellungen",
    market_title: "Kryptowährungsmarkt",
    search_placeholder: "Nach Name oder Symbol suchen...",
    search_button: "Suchen",
    previous: "Vorherige",
    next: "Nächste",
    page: "Seite {0}",
    rank: "#",
    coin: "Münze",
    price: "Preis (24h)",
    market_cap: "Marktkapitalisierung",
    dominance: "Dominanz",
    loading: "Laden...",
    loading_stats: "Echtzeitdaten werden geladen...",
    loading_table: "Münzen werden geladen...",
    price_label: "Preis: ",
    market_cap_label: "Marktkapitalisierung: ",
    dominance_label: "Dominanz: ",
    website_label: "Website: ",
    chart_error: "Fehler beim Laden des Diagramms",
    chart_label: "Preis (BRL) - Letzte 7 Tage",
    footer: "© 2025 CryptoPulse | Daten: CoinGecko",
    not_available: "Nicht verfügbar",
    modal_error: "Fehler beim Laden der Münzdetails",
    total_market_cap: "Gesamtmarktkapitalisierung",
    volume_24h: "24h Volumen",
    btc_dominance: "Bitcoin-Dominanz",
    no_results: "Keine Münzen gefunden",
    error_loading: "Fehler beim Laden der Daten. Bitte später erneut versuchen.",
    all_categories: "Alle Kategorien",
    defi: "DeFi",
    meme: "Meme-Münzen",
    stablecoin: "Stablecoins",
    layer1: "Layer 1",
    layer2: "Layer 2",
    cached_data: "Daten im Cache",
    api_error: "API-Fehler, Verwendung von Cache-Daten"
  }
};

// Estado global
let coinsData = [];
let sortColumn = 'cmc_rank';
let sortDirection = 1;
let currentPage = 1;
const itemsPerPage = 20;
let priceChart = null;
let debounceTimeout;
let totalMarketCap = 0;
let globalData = null;
const UPDATE_INTERVAL = 60 * 1000; // 1 minuto

// Dados de teste apenas para o gráfico do modal
const mockHistoricalData = {
  prices: Array.from({ length: 7 }, (_, i) => [Date.now() - (6 - i) * 24 * 60 * 60 * 1000, 340000 + i * 2000])
};

// Funções auxiliares
function sanitizeInput(input) {
  return input.replace(/[<>]/g, '').trim();
}

function formatPrice(price) {
  if (!price || isNaN(price)) return translations[localStorage.getItem('language') || 'pt'].not_available;
  return `R$ ${price.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 6 })}`;
}

function formatDominance(dominance) {
  if (dominance == null || isNaN(dominance) || dominance === 0) {
    return translations[localStorage.getItem('language') || 'pt'].not_available;
  }
  return `${dominance.toFixed(2)}%`;
}

async function updateMarketStats(data = globalData, isCached = false) {
  const stats = document.getElementById('market-stats');
  const lang = localStorage.getItem('language') || 'pt';

  if (!data) {
    console.warn('Nenhum dado global disponível, mantendo estado de carregamento');
    stats.classList.add('loading');
    return;
  }

  console.log(`Atualizando market-stats: total_market_cap=${data.total_market_cap.brl}, volume=${data.total_volume.brl}, btc_dominance=${data.market_cap_percentage.btc}, isCached=${isCached}`);

  document.getElementById('total-market-cap').textContent = data.total_market_cap.brl ?
    `R$ ${Number(data.total_market_cap.brl).toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[lang].not_available;
  document.getElementById('volume-24h').textContent = data.total_volume.brl ?
    `R$ ${Number(data.total_volume.brl).toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[lang].not_available;
  document.getElementById('btc-dominance').textContent = data.market_cap_percentage.btc ?
    `${Number(data.market_cap_percentage.btc).toFixed(2)}%` : translations[lang].not_available;

  const cacheIndicator = document.getElementById('cache-indicator');
  if (cacheIndicator && isCached) {
    cacheIndicator.textContent = translations[lang].cached_data;
    cacheIndicator.style.display = 'inline';
    setTimeout(() => cacheIndicator.style.display = 'none', 3000);
  }

  stats.classList.remove('loading');
}

function changeLanguage(lang) {
  localStorage.setItem('language', lang);
  const translation = translations[lang] || translations.pt;

  document.querySelectorAll('[data-i18n]').forEach(elem => {
    const key = elem.getAttribute('data-i18n');
    if (translation[key]) {
      if (key === 'page') {
        const currentPage = document.getElementById('page-info').textContent.match(/\d+/)?.[0] || 1;
        elem.textContent = translation[key].replace('{0}', currentPage);
      } else {
        elem.textContent = translation[key];
      }
    }
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
    const key = elem.getAttribute('data-i18n-placeholder');
    if (translation[key]) elem.placeholder = translation[key];
  });

  document.querySelectorAll('[data-i18n-prefix]').forEach(elem => {
    const key = elem.getAttribute('data-i18n-prefix');
    const currentText = elem.textContent.split(': ').slice(1).join(': ');
    if (translation[key]) elem.textContent = translation[key] + currentText;
  });

  // Atualizar textos de carregamento
  document.getElementById('market-stats').setAttribute('data-loading-text', translation.loading_stats);
  document.getElementById('crypto-table').setAttribute('data-loading-text', translation.loading_table);
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  const themeSpan = document.querySelector('.theme-toggle span');
  themeSpan.setAttribute('data-i18n', newTheme === 'dark' ? 'theme_dark' : 'theme_light');
  changeLanguage(localStorage.getItem('language') || 'pt');
}

function toggleDropdown() {
  const dropdown = document.getElementById('crypto-links');
  dropdown.classList.toggle('active');
}

async function fetchCryptoData() {
  const table = document.getElementById('crypto-table');
  const stats = document.getElementById('market-stats');
  table.classList.add('loading');
  stats.classList.add('loading');
  console.log('Iniciando fetchCryptoData...');

  try {
    console.log('Buscando dados do servidor...');
    const res = await fetch('/api/crypto');
    if (!res.ok) throw new Error(`Erro no servidor: ${res.status}`);
    const { globalData: fetchedGlobal, coinsData: fetchedCoins, cached } = await res.json();

    globalData = fetchedGlobal;
    coinsData = fetchedCoins;
    totalMarketCap = globalData.total_market_cap.brl;
    console.log(`Dados carregados: totalMarketCap=${totalMarketCap}, ${coinsData.length} moedas, cached=${cached}`);

    await updateMarketStats(globalData, cached);
    renderTable();
  } catch (err) {
    console.error('Erro em fetchCryptoData:', err.message);
    document.querySelector("#crypto-table tbody").innerHTML =
      `<tr><td colspan="5" class="error-message" data-i18n="error_loading">${translations[localStorage.getItem('language') || 'pt'].error_loading}</td></tr>`;
    stats.classList.remove('loading');
    table.classList.remove('loading');
  }
}

function getFilteredData() {
  const searchValue = sanitizeInput(document.getElementById("search-input").value.toLowerCase());
  const category = document.getElementById("category-filter").value;

  console.log(`Filtrando dados: search="${searchValue}", category="${category}"`);

  let filtered = coinsData;
  if (searchValue) {
    filtered = filtered.filter(coin =>
      coin.name.toLowerCase().includes(searchValue) ||
      coin.symbol.toLowerCase().includes(searchValue)
    );
  }
  if (category) {
    filtered = filtered.filter(coin => (coin.category || '') === category);
  }

  console.log(`Dados filtrados: ${filtered.length} moedas`);
  return filtered;
}

function getPageData(data) {
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  return data.slice(start, end);
}

function updatePagination(data) {
  const totalPages = Math.ceil(data.length / itemsPerPage);
  document.getElementById('prev-page').disabled = currentPage === 1;
  document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
  const lang = localStorage.getItem('language') || 'pt';
  document.getElementById('page-info').textContent = translations[lang].page.replace('{0}', currentPage);
  document.getElementById('pagination').style.display = data.length > itemsPerPage ? 'flex' : 'none';
}

function changePage(delta) {
  const totalPages = Math.ceil(getFilteredData().length / itemsPerPage);
  currentPage = Math.min(Math.max(1, currentPage + delta), totalPages);
  renderTable();
}

function renderTable() {
  const tbody = document.querySelector("#crypto-table tbody");
  const filteredData = getFilteredData();
  const pageData = getPageData(filteredData);

  console.log(`Renderizando tabela: ${pageData.length} moedas na página ${currentPage}`);

  tbody.innerHTML = pageData.length ? '' : `<tr><td colspan="5" class="no-results" data-i18n="no_results">${translations[localStorage.getItem('language') || 'pt'].no_results}</td></tr>`;
  pageData.forEach(coin => {
    const changeClass = (coin.quote.BRL.percent_change_24h || 0) >= 0 ? "positive" : "negative";
    const dominance = formatDominance(coin.quote.BRL.market_cap_dominance);
    console.log(`Renderizando ${coin.name}: Dominância=${dominance}`);
    tbody.innerHTML += `
      <tr onclick="showModal('${coin.id}', '${coin.slug}')">
        <td>${coin.cmc_rank || translations[localStorage.getItem('language') || 'pt'].not_available}</td>
        <td><img src="${coin.image}" class="coin-icon" alt="${coin.name}" loading="lazy" onerror="this.src='https://assets.coingecko.com/coins/images/1/small/bitcoin.png'">${coin.name} (${coin.symbol})</td>
        <td>${formatPrice(coin.quote.BRL.price)}<br><span class="${changeClass}">${(coin.quote.BRL.percent_change_24h || 0).toFixed(2)}%</span></td>
        <td>${coin.quote.BRL.market_cap ? `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[localStorage.getItem('language') || 'pt'].not_available}</td>
        <td>${dominance}</td>
      </tr>
    `;
  });

  updatePagination(filteredData);
  changeLanguage(localStorage.getItem('language') || 'pt');
}

async function filterTable() {
  const searchValue = sanitizeInput(document.getElementById("search-input").value.toLowerCase());
  const category = document.getElementById("category-filter").value;

  console.log(`Iniciando busca: search="${searchValue}", category="${category}"`);

  if (!searchValue && !category) {
    console.log('Busca vazia, restaurando dados');
    await fetchCryptoData();
    return;
  }

  const filteredCoins = coinsData.filter(coin =>
    (coin.name.toLowerCase().includes(searchValue) ||
     coin.symbol.toLowerCase().includes(searchValue)) &&
    (!category || (coin.category || '') === category)
  );

  console.log(`Moedas filtradas: ${filteredCoins.length}`);

  coinsData = filteredCoins;
  currentPage = 1;
  renderTable();
}

function debounceFilter() {
  clearTimeout(debounceTimeout);
  debounceTimeout = setTimeout(filterTable, 300);
}

function sortTable(column, toggle = true) {
  if (toggle) {
    document.querySelectorAll('th').forEach(th => th.classList.remove('sorted', 'desc'));
    const th = document.querySelector(`th[onclick="sortTable('${column}')"]`);
    sortColumn = column;
    sortDirection = sortColumn === column ? sortDirection * -1 : 1;
    th.classList.add('sorted', sortDirection === -1 ? 'desc' : '');
  }
  coinsData.sort((a, b) => {
    let valueA, valueB;
    switch (column) {
      case 'cmc_rank': valueA = a.cmc_rank || Infinity; valueB = b.cmc_rank || Infinity; break;
      case 'name': valueA = (a.name || '').toLowerCase(); valueB = (b.name || '').toLowerCase(); break;
      case 'price': valueA = a.quote.BRL.price || 0; valueB = b.quote.BRL.price || 0; break;
      case 'market_cap': valueA = a.quote.BRL.market_cap || 0; valueB = b.quote.BRL.market_cap || 0; break;
      case 'market_cap_dominance': valueA = a.quote.BRL.market_cap_dominance || 0; valueB = b.quote.BRL.market_cap_dominance || 0; break;
    }
    return typeof valueA === 'string' ? sortDirection * valueA.localeCompare(valueB) : sortDirection * (valueA - valueB);
  });
  renderTable();
}

async function showModal(coinId, coinSlug) {
  const coin = coinsData.find(c => c.id === coinId);
  if (!coin) {
    console.error(`Moeda ${coinId} não encontrada`);
    return;
  }
  const lang = localStorage.getItem('language') || 'pt';
  document.getElementById('modal-title').textContent = `${coin.name} (${coin.symbol})`;
  document.getElementById('modal-price').textContent = `${translations[lang].price_label}${formatPrice(coin.quote.BRL.price)}`;
  document.getElementById('modal-market-cap').textContent = `${translations[lang].market_cap_label}${coin.quote.BRL.market_cap ?
    `R$ ${coin.quote.BRL.market_cap.toLocaleString('pt-BR', { minimumFractionDigits: 0 })}` : translations[lang].not_available}`;
  document.getElementById('modal-dominance').textContent = `${translations[lang].dominance_label}${formatDominance(coin.quote.BRL.market_cap_dominance)}`;
  document.getElementById('modal-website').innerHTML = `${translations[lang].website_label}<a href="https://www.${coin.slug}.org" target="_blank">www.${coin.slug}.org</a>`;

  let historicalData = mockHistoricalData;
  try {
    const res = await fetch(`https://api.coingecko.com/api/v3/coins/${coinSlug}/market_chart?vs_currency=brl&days=7`);
    historicalData = await res.json();
    if (!res.ok) throw new Error('Erro ao carregar gráfico');
  } catch (err) {
    console.error('Erro ao carregar gráfico:', err.message);
    document.getElementById('modal-chart-error').style.display = 'block';
  }

  const ctx = document.getElementById('modal-chart').getContext('2d');
  if (priceChart) priceChart.destroy();
  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: historicalData.prices.map(p => new Date(p[0]).toLocaleDateString(lang === 'pt' ? 'pt-BR' : 'en-US', { day: 'numeric', month: 'short' })),
      datasets: [{
        label: translations[lang].chart_label,
        data: historicalData.prices.map(p => p[1]),
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.2)',
        fill: true,
        tension: 0.4,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { grid: { display: false }, ticks: { color: '#9ca3af' } },
        y: { ticks: { color: '#9ca3af', callback: value => `R$ ${value.toLocaleString('pt-BR')}` } }
      },
      plugins: {
        legend: { labels: { color: 'var(--text-color)' } },
        tooltip: { callbacks: { label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` } }
      }
    }
  });
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  if (priceChart) priceChart.destroy();
  document.getElementById('modal-chart-error').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
  const savedLang = localStorage.getItem('language') || 'pt';
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  document.querySelector('.theme-toggle span').setAttribute('data-i18n', savedTheme === 'dark' ? 'theme_dark' : 'theme_light');
  document.getElementById('language-select').value = savedLang;
  changeLanguage(savedLang);

  // Buscar dados imediatamente
  fetchCryptoData();

  // Configurar atualização periódica
  setInterval(() => {
    console.log('Iniciando atualização automática...');
    fetchCryptoData();
  }, UPDATE_INTERVAL);
});

document.addEventListener('click', e => {
  const dropdown = document.getElementById('crypto-links');
  if (!dropdown.contains(e.target) && !document.querySelector('.menu-icon').contains(e.target)) {
    dropdown.classList.remove('active');
  }
});

document.getElementById('modal').addEventListener('click', e => {
  if (e.target === document.getElementById('modal')) closeModal();
});
